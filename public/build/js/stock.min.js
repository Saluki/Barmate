app.model=app.model||{},app.model.Category=Backbone.Model.extend({urlRoot:"/app/stock/category",initialize:function(){},defaults:{title:"",description:"",active:!0}}),app.model=app.model||{},app.model.Product=Backbone.Model.extend({urlRoot:"/app/stock/product",initialize:function(){},defaults:{category:0,name:"",description:"",price:0,quantity:0}}),app.collection=app.collection||{},app.collection.Categories=Backbone.Collection.extend({model:app.model.Category,url:"/app/stock/category",currentID:-1,resetCurrentID:function(){this.currentID=-1,this.trigger("changed")},changeCurrentID:function(a){var b=parseInt(a);0>b||(this.currentID=b,this.trigger("changed"))}}),app.categories=new app.collection.Categories,app.collection=app.collection||{},app.collection.Products=Backbone.Collection.extend({model:app.model.Product,url:"/app/stock/product",currentID:-1}),app.products=new app.collection.Products,app.views=app.views||{},app.views.CategoryForm=Backbone.View.extend({el:"#new-category-form",initialize:function(){this.$inputTitle=$("#c-title"),this.$inputDescription=$("#c-description"),this.$saveButton=$("#btn-save-category")},events:{"click #btn-save-category":"saveCategory"},render:function(){return this},saveCategory:function(){var a=this.$inputTitle.val(),b=this.$inputDescription.val();if(a.length<1)var c="Title may not be empty";if(a.length>50)var c="Title may not be longer than 50 characters";if(void 0!=c)return void alertify.error(c);var d=this,e=new app.model.Category({title:a,description:b});e.save(null,{success:function(a,b){app.categories.add(e),d.clearForm(),alertify.success("Category <i>"+a.get("title")+"</i> created")},error:function(a,b){alertify.error("Problem on the server")}})},clearForm:function(){this.$inputTitle.val(""),this.$inputDescription.val("")}}),app.views=app.views||{},app.views.CategoryItem=Backbone.View.extend({className:"category-item",editMode:!1,templateDefault:_.template($("#template-category").html()),templateEdit:_.template($("#template-category-edit").html()),initialize:function(){this.listenTo(app.categories,"changed",this.setInactive)},events:{"click .title":"changeCurrentCategory","click .remove":"deleteCategory","click .edit":"editCategory","click .update":"updateCategory","click .cancel":"cancelEdit"},render:function(){if(this.$el.html(),0==this.editMode)var a=this.templateDefault(this.model.toJSON());else var a=this.templateEdit(this.model.toJSON());return this.$el.html(a),this},changeCurrentCategory:function(a){app.categories.changeCurrentID(this.model.get("id")),this.$el.addClass("active")},deleteCategory:function(a){currentView=this,this.model.destroy({success:function(a,b){currentView.remove(),app.categories.resetCurrentID(),alertify.success("Category <i>"+a.get("title")+"</i> deleted")},error:function(a,b){alertify.error(b.responseJSON.error)}})},editCategory:function(a){this.editMode=!0,this.render()},updateCategory:function(a){var b=$("#input-title").val(),c=$("#input-description").val();if(b.length<1)var d="Title may not be empty";if(b.length>50)var d="Title may not be longer than 50 characters";if(void 0!=d)return void alertify.error(d);var e=this;this.model.set({title:b,description:c}),this.model.save(null,{success:function(a,b){e.editMode=!1,e.render()},error:function(a,b){alertify.error(b.responseJSON.error)}})},cancelEdit:function(a){this.editMode=!1,this.render()},setInactive:function(){this.$el.removeClass("active"),this.cancelEdit()}}),app.views=app.views||{},app.views.CategoryList=Backbone.View.extend({el:"#category-list",events:{},initialize:function(){this.listenTo(app.categories,"reset",this.render),this.listenTo(app.categories,"add",this.render)},render:function(){return this.$el.html(""),app.categories.each(this.addToView,this),app.productList.render(),this},addToView:function(a){var b=new app.views.CategoryItem({model:a});this.$el.append(b.render().el)}}),app.views=app.views||{},app.views.ProductDisplay=Backbone.View.extend({el:"#product-display",editMode:!1,templateDisplay:_.template($("#template-product-display").html()),templateEdit:_.template($("#template-product-edit").html()),events:{"click #remove-product":"askRemove","click #edit-product":"editProduct","click #cancel-edit":"displayMode","click #update-product":"updateProduct"},initialize:function(){this.listenTo(app.categories,"changed",this.clear)},render:function(){var a=app.products.get(app.products.currentID);if(void 0!=a){if(0==this.editMode)var b=this.templateDisplay(a.toJSON());else var b=this.templateEdit(a.toJSON());return this.editMode=!1,this.trigger("render"),this.$el.html(b),this}},askRemove:function(){alertify.confirm("Confirm that you want to delete the product",this.removeProduct)},removeProduct:function(){var a=app.products.get(app.products.currentID);void 0!=a&&a.destroy({success:function(a,b){app.productDisplay.clear(),app.productList.render()},error:function(a,b){console.log(b)}})},updateProduct:function(){var a=app.products.get(app.products.currentID);if(void 0!=a){var b=$("#product-update-name").val(),c=$("#product-update-description").val(),d=parseFloat($("#product-update-price").val()),e=parseInt($("#product-update-qt").val());if(b.length<1||b.length>50)var f="Product name must be between 1 and 50 characters";if(c.length>250)var f="Description may not be longer than 250 characters";if(isNaN(d)||0>d)var f="Price must be a positive number";if(isNaN(e)||0>e)var f="Quantity must be a positive integer";if(void 0!=f)return void alertify.error(f);a.set({name:b,description:c,price:d,quantity:e});var g=this;a.save(null,{success:function(a,b){g.displayMode(),app.productList.render(),alertify.success("Product <i>"+a.get("name")+"</i> updated")},error:function(a,b){alertify.error(b.responseJSON.message)}})}},editProduct:function(){this.editMode=!0,this.render()},displayMode:function(){this.editMode=!1,this.render()},clear:function(){this.$el.html("")}}),app.views=app.views||{},app.views.ProductForm=Backbone.View.extend({el:"#product-form",events:{"click #save-product-btn":"saveProduct"},initialize:function(){this.hide(),this.$inputName=$("#p-name"),this.$inputDescription=$("#p-description"),this.$inputPrice=$("#p-price"),this.$inputQt=$("#p-quantity"),this.listenTo(app.productDisplay,"render",this.hide),this.listenTo(app.categories,"change",this.hide)},render:function(){return this},show:function(){app.productDisplay.clear(),app.productForm.$el.show()},hide:function(){this.$el.hide()},saveProduct:function(){var a=this.$inputName.val(),b=this.$inputDescription.val(),c=parseFloat(this.$inputPrice.val()),d=parseInt(this.$inputQt.val());if(void 0!=app.categories.currentID&&-1!=app.categories.currentID){if(a.length<1||a.length>50)var e="Product name must be between 1 and 50 characters";if(b.length>250)var e="Description may not be longer than 250 characters";if(isNaN(c)||0>c)var e="Price must be a positive number";if(isNaN(d)||0>d)var e="Quantity must be a positive integer";if(void 0!=e)return void alertify.error(e);var f=new app.model.Product({category:app.categories.currentID,name:a,description:b,price:c,quantity:d}),g=this;f.save(null,{success:function(a,b){app.products.add(f),app.productList.render(),g.clearForm()},error:function(a,b){alertify.error(b.responseJSON.message)}})}},clearForm:function(){this.$inputName.val(""),this.$inputDescription.val(""),this.$inputPrice.val(""),this.$inputQt.val("")}}),app.views=app.views||{},app.views.ProductList=Backbone.View.extend({el:"#product-list",template:_.template($("#template-product-list").html()),events:{"click .product":"displayProduct","click #add-product-btn":"showForm"},initialize:function(){this.listenTo(app.categories,"changed",this.render)},render:function(){if(-1==app.categories.currentID)var a="";else var b=app.products.where({category:app.categories.currentID}),a=this.template({products:b});return app.productForm.hide(),this.$el.html(a),this},displayProduct:function(a){var b=$(a.target).data("product");void 0!=b&&(app.products.currentID=b,app.productDisplay.render())},showForm:function(a){app.productForm.show()}});var app=app||{};$(document).ready(function(){alertify.set("notifier","position","top-right"),alertify.defaults.glossary.title="Barmate",app.categoryList=new app.views.CategoryList,app.categoryForm=new app.views.CategoryForm,app.productList=new app.views.ProductList,app.productDisplay=new app.views.ProductDisplay,app.productForm=new app.views.ProductForm,app.categories.reset(categoryData),app.products.fetch({reset:!0})});